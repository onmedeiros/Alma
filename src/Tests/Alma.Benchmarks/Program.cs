using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Running;
using Alma.Flows;
using Alma.Flows.Definitions;
using Alma.Flows.Options;
using Alma.Flows.Parsers;
using Microsoft.Extensions.DependencyInjection;
using System.Text.Json;

namespace Alma.Benchmarks
{
    public class Program
    {

        static async Task Main(string[] args)
        {
            var summary = BenchmarkRunner.Run<SimpleFlow>();
        }

        [MemoryDiagnoser]
        [MinColumn, MaxColumn, MeanColumn, MedianColumn]
        public class SimpleFlow
        {
            IServiceProvider _serviceProvider = default!;

            [GlobalSetup]
            public void Setup()
            {
                var services = new ServiceCollection();

                services.AddAlmaFlows(options =>
                {

                });

                services.AddLogging();

                _serviceProvider = services.BuildServiceProvider();
            }

            [Benchmark]
            public async Task RunDefinition()
            {
                var definitionString = "{\"StartId\":\"a762a797-cc74-4ac0-89a3-5dd78735f8eb\",\"Activities\":[{\"Id\":\"a762a797-cc74-4ac0-89a3-5dd78735f8eb\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:14:14.168Z\",\"Name\":\"StartActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.StartActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.StartActivity\",\"Parameters\":[],\"Metadata\":{\"PosX\":\"54\",\"PosY\":\"288\"}},{\"Id\":\"dd516eb8-dd1e-417e-ae7f-6e2b9d533f5a\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:14:22.838Z\",\"Name\":\"VariableActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.VariableActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.Data.VariableActivity\",\"Parameters\":[{\"Name\":\"Name\",\"ValueType\":\"String\",\"ValueString\":\"x\"},{\"Name\":\"Value\",\"ValueType\":\"String\",\"ValueString\":\"2\"}],\"Metadata\":{\"PosX\":\"306\",\"PosY\":\"288\"}},{\"Id\":\"261ecbff-df2f-495b-99b3-3eccb367430b\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:14:28.875Z\",\"Name\":\"VariableActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.VariableActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.Data.VariableActivity\",\"Parameters\":[{\"Name\":\"Name\",\"ValueType\":\"String\",\"ValueString\":\"y\"},{\"Name\":\"Value\",\"ValueType\":\"String\",\"ValueString\":\"3\"}],\"Metadata\":{\"PosX\":\"306\",\"PosY\":\"432\"}},{\"Id\":\"554f2b27-1137-48a9-89ba-1908ff53f720\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:14:44.164Z\",\"Name\":\"CalculateActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.CalculateActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.Data.CalculateActivity\",\"Parameters\":[{\"Name\":\"Expression\",\"ValueType\":\"String\",\"ValueString\":\"$var(x)*$var(y)\"}],\"Metadata\":{\"PosX\":\"630\",\"PosY\":\"288\"}},{\"Id\":\"486696f4-f456-4ac0-b7a3-ebbb0cda4a4b\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:15:10.834Z\",\"Name\":\"OutputVariableActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.OutputVariableActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.Data.OutputVariableActivity\",\"Parameters\":[{\"Name\":\"Name\",\"ValueType\":\"String\",\"ValueString\":\"result\"}],\"Metadata\":{\"PosX\":\"882\",\"PosY\":\"288\"}},{\"Id\":\"e978126e-7943-4d70-95cd-ecae74f60dbb\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:15:44.078Z\",\"Name\":\"ConditionActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.ConditionActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.Flow.ConditionActivity\",\"Parameters\":[{\"Name\":\"Expression\",\"ValueType\":\"String\",\"ValueString\":\"$var(result)\\u003E3\"}],\"Metadata\":{\"PosX\":\"1206\",\"PosY\":\"288\"}},{\"Id\":\"cfff3108-aa1d-481a-8fa2-d728bb514513\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:16:18.002Z\",\"Name\":\"WriteLineActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.WriteLineActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.WriteLineActivity\",\"Parameters\":[{\"Name\":\"Severity\",\"ValueType\":\"LogSeverity\",\"ValueString\":\"Information\"},{\"Name\":\"Message\",\"ValueType\":\"String\",\"ValueString\":\"Result\\u00E9maiorque3.\"}],\"Metadata\":{\"PosX\":\"1584\",\"PosY\":\"288\"}},{\"Id\":\"a7720fc4-8516-458a-b8a3-aad542b88c84\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:16:38.087Z\",\"Name\":\"WriteLineActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.WriteLineActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.WriteLineActivity\",\"Parameters\":[{\"Name\":\"Severity\",\"ValueType\":\"LogSeverity\",\"ValueString\":\"Information\"},{\"Name\":\"Message\",\"ValueType\":\"String\",\"ValueString\":\"Resultn\\u00E3o\\u00E9maiorque3.\"}],\"Metadata\":{\"PosX\":\"1584\",\"PosY\":\"414\"}},{\"Id\":\"69e6dbaa-f7a4-4090-8173-62657cdd35a8\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-12T01:16:42.342Z\",\"Name\":\"WriteLineActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.WriteLineActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.WriteLineActivity\",\"Parameters\":[{\"Name\":\"Severity\",\"ValueType\":\"LogSeverity\",\"ValueString\":\"Error\"},{\"Name\":\"Message\",\"ValueType\":\"String\",\"ValueString\":\"ErroaoavaliarResult.\"}],\"Metadata\":{\"PosX\":\"1584\",\"PosY\":\"540\"}},{\"Id\":\"448edf23-9ff4-4769-b496-6d7845142480\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-11T23:00:41.5156479-03:00\",\"Name\":\"CalculateActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.CalculateActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.Data.CalculateActivity\",\"Parameters\":[{\"Name\":\"Expression\",\"ValueType\":\"String\",\"ValueString\":\"n\"}],\"Metadata\":{\"PosX\":\"630\",\"PosY\":\"468\"}},{\"Id\":\"d1431e6a-fe27-4b05-bc59-34a6def06b64\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-11T23:00:53.9644414-03:00\",\"Name\":\"WriteLineActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.WriteLineActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.WriteLineActivity\",\"Parameters\":[{\"Name\":\"Severity\",\"ValueType\":\"LogSeverity\",\"ValueString\":\"Information\"},{\"Name\":\"Message\",\"ValueType\":\"String\",\"ValueString\":\"Calcularerradodeucerto.\"}],\"Metadata\":{\"PosX\":\"918\",\"PosY\":\"468\"}},{\"Id\":\"0115b14d-1d76-4406-b52a-e15001515c79\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-11T23:00:58.2211442-03:00\",\"Name\":\"WriteLineActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.WriteLineActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.WriteLineActivity\",\"Parameters\":[{\"Name\":\"Severity\",\"ValueType\":\"LogSeverity\",\"ValueString\":\"Error\"},{\"Name\":\"Message\",\"ValueType\":\"String\",\"ValueString\":\"Calcularerradodeuerrado\"}],\"Metadata\":{\"PosX\":\"918\",\"PosY\":\"594\"}},{\"Id\":\"85c0736b-66bc-464c-ba8a-4527af70ad2d\",\"Discriminator\":null,\"LastUpdate\":\"2025-02-11T23:01:36.0416006-03:00\",\"Name\":\"WriteLineActivity\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.WriteLineActivity\",\"CustomDisplayName\":null,\"Type\":\"Activity\",\"TypeName\":\"Alma.Flows.Activities.WriteLineActivity\",\"Parameters\":[{\"Name\":\"Severity\",\"ValueType\":\"LogSeverity\",\"ValueString\":\"Information\"},{\"Name\":\"Message\",\"ValueType\":\"String\",\"ValueString\":\"Oresultado\\u00E9:$var(result)\"}],\"Metadata\":{\"PosX\":\"1584\",\"PosY\":\"180\"}}],\"Connections\":[{\"Id\":\"b53da7d1-eb7e-4ada-b39e-5ff870173edf\",\"SourceActivityId\":\"a762a797-cc74-4ac0-89a3-5dd78735f8eb\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"dd516eb8-dd1e-417e-ae7f-6e2b9d533f5a\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"23491bfd-646a-437e-bf23-8d13d5d4bf9f\",\"SourceActivityId\":\"a762a797-cc74-4ac0-89a3-5dd78735f8eb\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"261ecbff-df2f-495b-99b3-3eccb367430b\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"4af89aa2-650e-4e78-8a43-9831e43f1f43\",\"SourceActivityId\":\"dd516eb8-dd1e-417e-ae7f-6e2b9d533f5a\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"554f2b27-1137-48a9-89ba-1908ff53f720\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"ac3ea227-cd30-46ac-ade3-6453342285ab\",\"SourceActivityId\":\"261ecbff-df2f-495b-99b3-3eccb367430b\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"554f2b27-1137-48a9-89ba-1908ff53f720\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"42350007-47a2-4187-aec4-a074992703e5\",\"SourceActivityId\":\"554f2b27-1137-48a9-89ba-1908ff53f720\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"486696f4-f456-4ac0-b7a3-ebbb0cda4a4b\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"d4aa1f1c-5494-4974-a279-d9a5292858c0\",\"SourceActivityId\":\"486696f4-f456-4ac0-b7a3-ebbb0cda4a4b\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"e978126e-7943-4d70-95cd-ecae74f60dbb\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"ed1548cf-a08a-4fc0-bef9-47b8f3db5563\",\"SourceActivityId\":\"e978126e-7943-4d70-95cd-ecae74f60dbb\",\"SourceActivityPort\":\"True\",\"TargetActivityId\":\"cfff3108-aa1d-481a-8fa2-d728bb514513\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"15825baa-f908-44a6-8091-e43c9c9dae2f\",\"SourceActivityId\":\"e978126e-7943-4d70-95cd-ecae74f60dbb\",\"SourceActivityPort\":\"False\",\"TargetActivityId\":\"a7720fc4-8516-458a-b8a3-aad542b88c84\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"2ca967d8-d4a7-467a-9ce7-7ae9cf531b15\",\"SourceActivityId\":\"e978126e-7943-4d70-95cd-ecae74f60dbb\",\"SourceActivityPort\":\"Fail\",\"TargetActivityId\":\"69e6dbaa-f7a4-4090-8173-62657cdd35a8\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"88c16ef4-1bd5-4c8f-87f0-50acee4946ff\",\"SourceActivityId\":\"261ecbff-df2f-495b-99b3-3eccb367430b\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"448edf23-9ff4-4769-b496-6d7845142480\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"ede6f31b-12d4-46c3-b55e-49bdc4eab966\",\"SourceActivityId\":\"448edf23-9ff4-4769-b496-6d7845142480\",\"SourceActivityPort\":\"Done\",\"TargetActivityId\":\"d1431e6a-fe27-4b05-bc59-34a6def06b64\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"d380d012-42cf-4e13-8b5f-7fcdad0a6064\",\"SourceActivityId\":\"448edf23-9ff4-4769-b496-6d7845142480\",\"SourceActivityPort\":\"Fail\",\"TargetActivityId\":\"0115b14d-1d76-4406-b52a-e15001515c79\",\"TargetActivityPort\":\"Input\"},{\"Id\":\"d20d4050-eadd-4f05-bf79-68894367299b\",\"SourceActivityId\":\"e978126e-7943-4d70-95cd-ecae74f60dbb\",\"SourceActivityPort\":\"True\",\"TargetActivityId\":\"85c0736b-66bc-464c-ba8a-4527af70ad2d\",\"TargetActivityPort\":\"Input\"}],\"Id\":\"f1b611d0-b8d2-4610-bac8-c61564602908\",\"Discriminator\":\"0dda0a6e-8356-46ca-bda7-0610bd1f4d89\",\"LastUpdate\":\"2025-02-11T23:02:18.9558347-03:00\",\"Name\":\"Benchmark\",\"Namespace\":\"Alma.Flows\",\"FullName\":\"Alma.Flows.Flow\",\"CustomDisplayName\":null,\"Type\":\"Flow\",\"TypeName\":\"Alma.Flows.Flow\",\"Parameters\":[],\"Metadata\":{\"AutoSave\":\"True\",\"Zoom\":\"0,6944444444444445\",\"PanX\":\"-23,547777777777767\",\"PanY\":\"30,898888888888905\"}}";
                var definition = JsonSerializer.Deserialize<FlowDefinition>(definitionString);

                var parser = _serviceProvider.GetRequiredService<IFlowDefinitionParser>();
                parser.TryParse(definition!, out var flow);

                if (flow is null)
                    throw new Exception("Flow é nulo.");
                var runner = _serviceProvider.GetRequiredService<IFlowRunManager>();
                await runner.RunAsync(flow!, new ExecutionOptions
                {
                    MaxDegreeOfParallelism = 4
                });
            }
        }
    }
}

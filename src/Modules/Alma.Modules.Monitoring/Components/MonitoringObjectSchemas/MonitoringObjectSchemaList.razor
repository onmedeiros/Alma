@page "/monitoring/objects/schemas"
@using Alma.Modules.Monitoring.Components.MonitoringObjectSchemas.Dialogs
@using Alma.Flows.Monitoring.MonitoringObjectSchemas.Entities
@using Alma.Flows.Monitoring.MonitoringObjectSchemas.Models
@using Alma.Flows.Monitoring.MonitoringObjectSchemas.Services
@using Microsoft.Extensions.DependencyInjection

@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IServiceScopeFactory ScopeFactory


<Page Title="Estruturas de Objetos de Monitoramento">

    <Tools>
        <MudButton OnClick="Create" Variant="Variant.Filled" StartIcon="@Icons.Material.Outlined.Add" Color="Color.Primary" Class="me-2">Criar</MudButton>
    </Tools>


    <ChildContent>
        <MudDataGrid @ref="_dataGrid"
                     T="MonitoringObjectSchema"
                     ServerData="Load"
                     CurrentPage="(PageIndex ?? 1) - 1"
                     RowsPerPage="PageSize ?? 10"
                     Elevation="8"
                     Hover="true"
                     SortMode="SortMode.None">

            <ToolBarContent>
                <MudText Typo="Typo.h6">Lista de estruturas</MudText>
                <MudSpacer></MudSpacer>
                <MudTextField @bind-Value="Term" Placeholder="Buscar" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Outlined.Search" OnAdornmentClick="_dataGrid.ReloadServerData" Class="mt-0 me-2"></MudTextField>
            </ToolBarContent>

            <Columns>
                <PropertyColumn Title="Nome" Property="x => x.Name" />
                <PropertyColumn Title="Criado em" Property="x => x.CreatedAt.ToLocalTime()" HeaderStyle="@DefaultHeaderStyle.DateTime" />
                <PropertyColumn Title="Atualizado em" Property="x => x.ModifiedAt.ToLocalTime()" HeaderStyle="@DefaultHeaderStyle.DateTime" />

                <TemplateColumn HeaderStyle="@DefaultHeaderStyle.Tools">
                    <CellTemplate>
                        <MudIconButton Href="@($"/monitoring/objects/schemas/edit/{context.Item.Id}")" Icon="@Icons.Material.Outlined.Edit" Size="MudBlazor.Size.Small" />
                    </CellTemplate>
                </TemplateColumn>

            </Columns>

            <NoRecordsContent>Nenhuma estrutura cadastrada para a organização.</NoRecordsContent>

            <PagerContent>
                <MudDataGridPager T="MonitoringObjectSchema" />
            </PagerContent>
        </MudDataGrid>
    </ChildContent>
</Page>

@code {
    [CascadingParameter]
    public required Organization Organization { get; set; }

    #region Query Parameters

    [SupplyParameterFromQuery]
    public int? PageIndex { get; set; }

    [SupplyParameterFromQuery]
    public int? PageSize { get; set; }

    [SupplyParameterFromQuery]
    public string? Term { get; set; }

    #endregion

    #region private fields

    private MudDataGrid<MonitoringObjectSchema> _dataGrid = new MudDataGrid<MonitoringObjectSchema>();

    #endregion

    private async Task<GridData<MonitoringObjectSchema>> Load(GridState<MonitoringObjectSchema> state)
    {
        PageIndex = state.Page + 1;
        PageSize = state.PageSize;

        UpdateQueryParameters();

        using var scope = ScopeFactory.CreateScope();

        var service = scope.ServiceProvider.GetRequiredService<IMonitoringObjectSchemaService>();

        var model = new MonitoringObjectSchemaSearchModel
        {
            PageIndex = PageIndex ?? 1,
            PageSize = PageSize ?? 10,
            Term = Term,
            OrganizationId = Organization.Id
        };

        var result = await service.SearchAsync(model);

        return new GridData<MonitoringObjectSchema>
        {
            Items = result.Items,
            TotalItems = result.TotalCount
        };
    }

    private void UpdateQueryParameters()
    {
        var parameters = new Dictionary<string, object?>
        {
            ["term"] = Term,
            ["pageIndex"] = PageIndex ?? 1,
            ["pageSize"] = PageSize ?? 10,
        };

        NavigationManager.NavigateTo(NavigationManager.GetUriWithQueryParameters(parameters));
    }

    private async Task Create()
    {
        var parameters = new DialogParameters<MonitoringObjectSchemaCreateDialog>
        {
            { x => x.Organization, Organization }
        };

        var dialog = await DialogService.ShowAsync<MonitoringObjectSchemaCreateDialog>("Criar nova estrutura de objeto de monitoramento", parameters);
        var result = await dialog.Result;

        if (result is null || result.Canceled)
            return;

        if (result.Data is MonitoringObjectSchema schema)
        {
            await _dataGrid.ReloadServerData();
        }
    }
}

@using Alma.Modules.Workflows.Models.CustomActivities
@using Alma.Workflows.Core.CustomActivities.Services
@using Microsoft.Extensions.DependencyInjection

@inject IDialogService DialogService;
@inject ISnackbar Snackbar;
@inject IServiceScopeFactory ScopeFactory;

<MudDialog>
    <DialogContent>
        @if (_model is not null)
        {
            <EditForm Model="_model" OnSubmit="Save">
                <FluentValidationValidator @ref="_validator" />

                <MudText Class="mb-2">Informações da atividade personalizada:</MudText>
                <MudTextField @bind-Value="_model.Name" For="@(() => _model.Name)" Label="Nome" Class="mb-5" Variant="Variant.Outlined" Margin="Margin.Dense" />

                <SubmitButton IsSaving="_isSaving" Class="mb-2" />
            </EditForm>
        }
    </DialogContent>
</MudDialog>

@code {

    #region Parameters

    [CascadingParameter]
    public IMudDialogInstance Dialog { get; set; } = null!;

    [Parameter]
    public Organization Organization { get; set; } = null!;

    #endregion

    #region Private fields

    private bool _isSaving = false;
    private CustomActivityCreateModel _model = null!;
    private FluentValidationValidator _validator = null!;

    #endregion

    protected override async Task OnParametersSetAsync()
    {
        await Dialog.SetOptionsAsync(new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true,
        });
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _model = new CustomActivityCreateModel
            {
                Name = string.Empty
            };

            StateHasChanged();
        }
    }

    private async Task Save()
    {
        _isSaving = true;
        StateHasChanged();

        if (!await _validator!.ValidateAsync())
        {
            await DialogService.ShowErrorDialog("Erro de validação", "Alguns campos não estão preenchidos corretamente.");

            _isSaving = false;
            StateHasChanged();

            return;
        }

        var scope = ScopeFactory.CreateScope();
        var customActivityManager = scope.ServiceProvider.GetRequiredService<ICustomActivityManager>();

        try
        {
            var activity = await customActivityManager.Create(_model.Name!, Organization.Id);

            Snackbar.AddSuccess("Atividade personalizada criada com sucesso.");

            Dialog.Close(DialogResult.Ok(activity));
        }
        catch (Exception ex)
        {
            await DialogService.ShowErrorDialog("Erro ao criar atividade personalizada", ex.Message);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}

@page "/Auctions/AwardedLots/edit/{id}"

@using Alma.Modules.Auctions.AwardedLots.Entities
@using Alma.Modules.Auctions.AwardedLots.Models
@using Alma.Modules.Auctions.AwardedLots.Services
@using Microsoft.Extensions.DependencyInjection

@inject NavigationManager NavigationManager
@inject IServiceScopeFactory ScopeFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<Page Title="Editar lote arrematado">
    <PageContent>
        @if (_model == null)
        {
            if (_isLoading)
            {
                <MudStack Row="true" Justify="Justify.Center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </MudStack>
            }
        }
        else
        {
            <MudStack Class="mud-width-full">

                <FormTextData Label="Id" Value="@Id" />

                <FormTextData Label="Data de criação" Value="@_entity.CreatedAt.ToLocalTime().ToString()" />

                <FormTextData Label="Última atualização" Value="@_entity.ModifiedAt.ToLocalTime().ToString()" />

                <MudDivider Class="mt-2 mb-2" />

                <EditForm Model="@_model" OnSubmit="Save">
                    <FluentValidationValidator @ref="_validator" />

                    <MudText Typo="Typo.body2" Class="mb-3"><b>Informações do lote arrematado</b></MudText>

                    <MudTextField @bind-Value="_model.Name" For="@(() => _model.Name)" Label="Nome" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />

                    <MudTextField @bind-Value="_model.Description" For="@(() => _model.Description)" Label="Descrição" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" Lines="3" />

                    <MudTextField @bind-Value="_model.AuctionHouse" For="@(() => _model.AuctionHouse)" Label="Casa de leilão" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />

                    <MudDatePicker @bind-Date="_model.AuctionDate" For="@(() => _model.AuctionDate)" Label="Data do leilão" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />

                    <MudTextField @bind-Value="_model.AuctionLink" For="@(() => _model.AuctionLink)" Label="Link do leilão" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />

                    <MudNumericField @bind-Value="_model.WinningBid" For="@(() => _model.WinningBid)" Label="Valor do lance vencedor" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" Format="N2" />

                    <MudNumericField @bind-Value="_model.WinningFees" For="@(() => _model.WinningFees)" Label="Valor das taxas" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" Format="N2" />

                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3">
                        <SubmitButton IsSaving="@_isSaving" />
                    </MudStack>

                </EditForm>
            </MudStack>
        }
    </PageContent>
</Page>

@code {
    #region Parameters

    [Parameter]
    public string? Id { get; set; }

    #endregion

    #region Private fields

    bool _isSaving = false;
    bool _isLoading = true;

    FluentValidationValidator? _validator;
    AwardedLot _entity = null!;
    EditAwardedLotModel? _model = null!;

    #endregion

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Load();
        }
    }

    private async Task Load()
    {
        if (string.IsNullOrEmpty(Id))
        {
            await DialogService.ShowErrorDialog("Não foi possível carregar os dados do lote arrematado", "Parâmetro ID não informado.");
            return;
        }

        _isLoading = true;
        StateHasChanged();

        var scope = ScopeFactory.CreateScope();
        var service = scope.ServiceProvider.GetRequiredService<IAwardedLotService>();

        try
        {
            var awardedLot = await service.FindByIdAsync(Id);

            if (awardedLot is null)
            {
                await DialogService.ShowErrorDialog("Não foi possível carregar os dados do lote arrematado", "Lote arrematado não encontrado.");
                return;
            }

            _entity = awardedLot;

            _model = new EditAwardedLotModel
            {
                Id = awardedLot.Id,
                Name = awardedLot.Name,
                Description = awardedLot.Description,
                AuctionHouse = awardedLot.AuctionHouse,
                AuctionDate = awardedLot.AuctionDate,
                AuctionLink = awardedLot.AuctionLink,
                WinningBid = awardedLot.WinningBid,
                WinningFees = awardedLot.WinningFees
            };
        }
        catch (Exception ex)
        {
            await DialogService.ShowErrorDialog("Erro ao carregar dados do lote arrematado", ex.Message);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task Save()
    {
        _isSaving = true;
        StateHasChanged();

        if (_model is null || !await _validator!.ValidateAsync())
        {
            await DialogService.ShowErrorDialog("Erro de validação", "Alguns campos não estão preenchidos corretamente.");

            _isSaving = false;
            StateHasChanged();

            return;
        }

        var scope = ScopeFactory.CreateScope();
        var service = scope.ServiceProvider.GetRequiredService<IAwardedLotService>();

        try
        {
            await service.UpdateAsync(_model);
            Snackbar.AddSuccess("Lote arrematado salvo com sucesso.");
        }
        catch (Exception ex)
        {
            await DialogService.ShowErrorDialog("Erro ao salvar lote arrematado", ex.Message);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}

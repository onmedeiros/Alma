@page "/flows/definitions"
@using Alma.Organizations.Entities
@using Alma.Flows
@using Alma.Flows.Definitions
@using Alma.Flows.Stores.Filters
@using Microsoft.Extensions.DependencyInjection


@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IServiceScopeFactory ScopeFactory

<Page Title="Definições">

    <Tools>
        <MudButton OnClick="CreateDefinition" Variant="Variant.Filled" StartIcon="@Icons.Material.Outlined.Add" Color="Color.Primary" Class="me-2">Criar</MudButton>
    </Tools>

    <ChildContent>
        <MudDataGrid @ref="_dataGrid"
        T="FlowDefinition"
        ServerData="LoadData"
        CurrentPage="(PageIndex ?? 1) - 1"
        RowsPerPage="PageSize ?? 10"
        Elevation="8"
        Hover="true"
        SortMode="SortMode.None">

            <ToolBarContent>
                <MudText Typo="Typo.h6">Lista de definições</MudText>
                <MudSpacer></MudSpacer>
                <MudTextField @bind-Value="Name" Placeholder="Buscar pelo nome" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Outlined.Search" OnAdornmentClick="_dataGrid.ReloadServerData" Class="mt-0 me-2"></MudTextField>
            </ToolBarContent>

            <Columns>
                <TemplateColumn Title="Nome">
                    <CellTemplate>
                        @context.Item.Name
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn HeaderStyle="width: 60px;">
                    <CellTemplate>
                        <MudIconButton Href="@($"/flows/definitions/edit/{context.Item.Id}")" Icon="@Icons.Material.Outlined.Edit" Size="MudBlazor.Size.Small" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            

            <NoRecordsContent>Nenhuma definição criada.</NoRecordsContent>

            <PagerContent>
                <MudDataGridPager T="FlowDefinition" />
            </PagerContent>
        </MudDataGrid>
    </ChildContent>
</Page>

@code {
    [CascadingParameter]
    public required Organization Organization { get; set; }

    #region Query Parameters

    [SupplyParameterFromQuery]
    public int? PageIndex { get; set; }

    [SupplyParameterFromQuery]
    public int? PageSize { get; set; }

    [SupplyParameterFromQuery]
    public string? Name { get; set; }

    #endregion

    #region private fields

    private MudDataGrid<FlowDefinition> _dataGrid = new MudDataGrid<FlowDefinition>();

    #endregion


    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
    }

    private async Task<GridData<FlowDefinition>> LoadData(GridState<FlowDefinition> state)
    {
        UpdateQueryParameters();

        using var scope = ScopeFactory.CreateScope();
        var service = scope.ServiceProvider.GetRequiredService<IFlowManager>();

        var filters = new FlowDefinitionFilters
        {
            Name = Name,
            Discriminator = Organization.Id
        };

        var result = await service.ListDefinitions(PageIndex ?? 1, PageSize ?? 10, filters);

        return new GridData<FlowDefinition>
        {
            Items = result.Items,
            TotalItems = result.TotalCount
        };
    }

    private void UpdateQueryParameters()
    {
        var parameters = new Dictionary<string, object?>
        {
            ["name"] = Name,
            ["pageIndex"] = PageIndex ?? 1,
            ["pageSize"] = PageSize ?? 10,
        };

        NavigationManager.NavigateTo(NavigationManager.GetUriWithQueryParameters(parameters));
    }

    private async Task CreateDefinition()
    {
        var parameters = new DialogParameters<DefinitionCreateDialog>
        {
            { x => x.Organization, Organization }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DefinitionCreateDialog>("Criar nova definição", parameters, options);
        var result = await dialog.Result;

        if (result == null || result.Canceled)
            return;

        if (result.Data is not null && result.Data is FlowDefinition definition)
            NavigationManager.NavigateTo("/flows/definitions/edit/" + definition.Id);
    }
}
